{
  "$schema": "https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json",
  "scopeName": "source.ts.typesugar",
  "injectionSelector": "L:source.ts, L:source.tsx",
  "patterns": [
    { "$comment": "Labeled block comprehensions: let: { ... }, yield: { ... }, pure: { ... }" },
    {
      "name": "meta.comprehension.let.typesugar",
      "begin": "(?<=^|;|\\{|\\})\\s*\\b(let)\\s*(:)\\s*(\\{)",
      "beginCaptures": {
        "1": { "name": "keyword.control.comprehension.let.typesugar" },
        "2": { "name": "punctuation.separator.comprehension.typesugar" },
        "3": { "name": "punctuation.section.block.begin.typesugar" }
      },
      "end": "(\\})",
      "endCaptures": {
        "1": { "name": "punctuation.section.block.end.typesugar" }
      },
      "patterns": [{ "include": "#comprehension-body" }, { "include": "source.ts" }]
    },
    {
      "name": "meta.comprehension.yield.typesugar",
      "begin": "(?<=\\})\\s*\\b(yield|pure)\\s*(:)\\s*(\\{)",
      "beginCaptures": {
        "1": { "name": "keyword.control.comprehension.yield.typesugar" },
        "2": { "name": "punctuation.separator.comprehension.typesugar" },
        "3": { "name": "punctuation.section.block.begin.typesugar" }
      },
      "end": "(\\})",
      "endCaptures": {
        "1": { "name": "punctuation.section.block.end.typesugar" }
      },
      "patterns": [{ "include": "source.ts" }]
    },
    { "$comment": "Monadic bind operator: name << expr" },
    {
      "match": "\\b(\\w+)\\s*(<<)(?!=)",
      "captures": {
        "1": { "name": "variable.other.bind.typesugar" },
        "2": { "name": "keyword.operator.bind.typesugar" }
      }
    },
    { "$comment": "Discard bind: _ << expr" },
    {
      "match": "\\b(_)\\s*(<<)(?!=)",
      "captures": {
        "1": { "name": "variable.language.discard.typesugar" },
        "2": { "name": "keyword.operator.bind.typesugar" }
      }
    },
    { "$comment": "Compile-time macro calls — matched by name for base coloring" },
    {
      "match": "\\b(comptime)\\s*(?=\\()",
      "captures": {
        "1": { "name": "entity.name.function.macro.comptime.typesugar" }
      }
    },
    { "$comment": "Expression macros — common built-ins" },
    {
      "match": "\\b(ops|pipe|compose|summon|extend|typeInfo|fieldNames|validator|Do|forYield|asyncDo|specialize)\\s*(?=\\(|<)",
      "captures": {
        "1": { "name": "entity.name.function.macro.typesugar" }
      }
    },
    { "$comment": "Decorator macros" },
    {
      "match": "(@)(derive|operators|reflect|typeclass|instance|deriving|inline)\\b",
      "captures": {
        "1": { "name": "punctuation.decorator.typesugar" },
        "2": { "name": "entity.name.function.decorator.macro.typesugar" }
      }
    },
    { "$comment": "Tagged template macros — the tag name before a backtick" },
    {
      "match": "\\b(sql|regex|html|fmt|json|raw|units)(?=\\s*`)",
      "captures": {
        "1": { "name": "entity.name.tag.macro.typesugar" }
      }
    }
  ],
  "repository": {
    "comprehension-body": {
      "patterns": [
        {
          "match": "\\b(\\w+)\\s*(<<)\\s*(.+?)\\s*(\\|\\||\\?\\?)\\s*",
          "captures": {
            "1": { "name": "variable.other.bind.typesugar" },
            "2": { "name": "keyword.operator.bind.typesugar" },
            "4": { "name": "keyword.operator.orelse.typesugar" }
          }
        },
        {
          "match": "\\b(_)\\s*(<<)(?!=)",
          "captures": {
            "1": { "name": "variable.language.discard.typesugar" },
            "2": { "name": "keyword.operator.bind.typesugar" }
          }
        },
        {
          "match": "\\b(\\w+)\\s*(<<)(?!=)",
          "captures": {
            "1": { "name": "variable.other.bind.typesugar" },
            "2": { "name": "keyword.operator.bind.typesugar" }
          }
        }
      ]
    }
  }
}
